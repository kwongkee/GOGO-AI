<?php
require '../vendor/autoload.php';
use Predis\Client;

function compress_image_base64($base64_string, $quality=50) {
    $img_data = base64_decode($base64_string);
    $img = imagecreatefromstring($img_data);
    ob_start();
    imagejpeg($img, null, $quality);
    $compressed_data = ob_get_clean();
    imagedestroy($img);
    return base64_encode($compressed_data);
}

$config = parse_ini_file('/app/config.ini');

$max_size = $config['max_file_size'] ?? 100 * 1024 * 1024;
$max_files = $config['max_file_count'] ?? 10;
$allowed_extensions = ['mp3', 'mp4', 'jpg', 'png', 'jpeg', 'pdf', 'txt', 'pptx', 'docx', 'xls', 'xlsx'];

$redis = new Client(['host' => 'localhost', 'port' => 6379]);

$question = $_POST['question'] ?? '';
if(empty($question)){
    echo json_encode(['status'=>'error','message'=>'消息内容不能为空！']);exit;
}
$images_base64 = $_POST['images_base64'] ?? [];
$audios_base64 = $_POST['audios_base64'] ?? [];
$videos_base64 = $_POST['videos_base64'] ?? [];
$files = $_FILES ?? [];
$mode = $_POST['mode'] ?? 'query';

if ($mode == 'learn' && !empty($files)) {
    if (count($files) > $max_files) {
        http_response_code(413);
        die(json_encode(["error" => "文件数量过多，最大：$max_files"]));
    }
    $filePaths = [];
    foreach ($files as $file) {
        $ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
        if (!in_array($ext, $allowed_extensions)) {
            http_response_code(415);
            die(json_encode(["error" => "不支持的文件类型：$ext"]));
        }
        if ($file['size'] > $max_size) {
            http_response_code(413);
            die(json_encode(["error" => "文件过大，最大：" . ($max_size / 1024 / 1024) . "MB"]));
        }
        $filePath = "/uploads/knowledge_files/".date('Ymd').'/'. basename($file['name']);
        move_uploaded_file($file['tmp_name'], $filePath);
        $filePaths[] = $filePath;
    }
    // 异步索引，设置30秒超时
    $task_id = uniqid();
    $redis->rpush('index_tasks', json_encode(['task_id' => $task_id, 'file_paths' => $filePaths]));
    $redis->setex("index_task:{task_id}", 30, "pending");  // 新增：30秒超时
    http_response_code(202);
    echo json_encode(["status" => "processing", "task_id" => $task_id]);
    exit;
}

foreach ($images_base64 as &$img) {
    if (strlen($img) > 10 * 1024 * 1024) {
        $img = compress_image_base64($img, 50);
    }
}
unset($img);

$data = json_encode([
    'text' => $question,
    'images' => $images_base64,
    'audios' => $audios_base64,
    'videos' => $videos_base64
]);

$ch = curl_init('http://47.254.122.81:5000/predict');
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
curl_close($ch);
// echo $response;

$starttime = microtime(true);

// 设置更长的脚本执行时间
set_time_limit(180);

// 数据库配置
define('DB_HOST', 'rm-wz9mt4j79jrdh0p3z.mysql.rds.aliyuncs.com');
define('DB_NAME', 'shop');
define('DB_USER', 'gogo198');
define('DB_PASS', 'Gogo@198');

$chat_pid = isset($_POST['chat_pid'])?intval($_POST['chat_pid']):0;
$uid = isset($_POST['uid'])?intval($_POST['uid']):0;

//判断聊天上级id是否大于0
if($chat_pid>0 && isset($response['content'])){
    /**
     * 获取PDO数据库连接
     */
    function getDBConnection() {
        try {
            $dsn = "mysql:host=".DB_HOST.";dbname=".DB_NAME.";charset=utf8mb4";
            $pdo = new PDO($dsn, DB_USER, DB_PASS);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
            return $pdo;
        } catch (PDOException $e) {
            error_log("数据库连接失败: " . $e->getMessage());
            return false;
        }
    }

    function removeThinkTags($input) {
        $pattern = '/<think>.*?<\/think>\s*/s';
        return preg_replace($pattern, '', $input);
    }

    function httpRequest($url,$data,$head=[])
    {
        $ch=curl_init();
        curl_setopt($ch,CURLOPT_URL,$url);
        curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);
        curl_setopt($ch,CURLOPT_SSL_VERIFYPEER,false);
        curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,false);
        curl_setopt($ch,CURLOPT_POST,1);
        curl_setopt($ch,CURLOPT_POSTFIELDS,$data);
        curl_setopt($ch, CURLOPT_HTTPHEADER,$head);
        $output=curl_exec($ch);
        curl_close($ch);
        return $output;
    }

    try {
        $pdo = getDBConnection();
        if (!$pdo) {
            // 返回错误信息
            echo json_encode(['status' => 'error', 'message' => '数据库连接失败']);
            exit;
        }

        #1、查找上级聊天记录（使用参数化查询更安全）
        $sql = 'SELECT * FROM ims_website_chatlist WHERE id = :chat_pid';
        $stmt = $pdo->prepare($sql);
        $stmt->execute([':chat_pid' => $chat_pid]);
        $pinfo = $stmt->fetch();

        if (!$pinfo) {
            // 处理上级记录不存在的情况
            echo json_encode(['status' => 'error', 'message' => '上级聊天记录不存在']);
            exit;
        }

        // 将答案作为回复，隐藏<think>推理
        $cleanText = removeThinkTags($response['content']);

        #2、记录AI回答（使用参数化查询解决所有问题）
        $insert_sql = 'INSERT INTO ims_website_chatlist 
                  (company_id, pid, uid, who_send, is_read, content_type, `language`, origin_content, content, ip, is_ai, ai_times, createtime) 
                  VALUES 
                  (:company_id, :pid, :uid, :who_send, :is_read, :content_type, :language2, :origin_content, :content, :ip, :is_ai, :ai_times, :createtime)';

        $stmt2 = $pdo->prepare($insert_sql);

        $endtime = microtime(true);#结束时间
        $executiontime = $endtime - $starttime;

        // 绑定参数
        $params = [
            ':company_id' => $pinfo['company_id'],
            ':pid' => $pinfo['id'],
            ':uid' => $pinfo['uid'],
            ':who_send' => 1,
            ':is_read' => 0,
            ':content_type' => 1,
            ':language2' => $pinfo['language'],
            ':origin_content' => json_encode($cleanText, true),
            ':content' => '',
            ':ip' => $_SERVER['REMOTE_ADDR'],
            ':is_ai' => 1,
            ':ai_times' => number_format($executiontime, 2),
            ':createtime' => time()
        ];

        $stmt2->execute($params);
        $insertId = $pdo->lastInsertId();  // 正确获取最后插入ID

        if ($insertId > 0) {
            #3、按照用户的语种，翻译回用户的语种，并保留当前国地语种的回答
            httpRequest('https://shop.gogo198.cn/collect_website/public/?s=api/getgoods/translate_answer',['answer_id'=>$insertId, 'is_convert_customer'=>1, 'translate_back_language'=>$pinfo['language']]);

            echo json_encode(['status'=>'success', 'insert_id' => $insertId, 'chat_id' => $pinfo['id']]);
        } else {
            echo json_encode(['status'=>'success', 'insert_id' => 0, 'chat_id' => $pinfo['id']]);
        }
    }
    catch (PDOException $e) {
        // 数据库相关异常处理
        error_log("数据库错误: " . $e->getMessage());
        echo json_encode([
            'status'  => 'error',
            'message' => '数据库操作失败，请稍后重试：'.$e->getMessage()
        ]);
    } catch (Exception $e) {
        // 其他业务逻辑异常处理
        error_log("业务错误: " . $e->getMessage());
        echo json_encode([
            'status'  => 'error',
            'message' => $e->getMessage()
        ]);
    }
}
?>